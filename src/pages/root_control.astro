---
import "../styles/global.css";

const currentTime = new Date().toLocaleString("en-US", {
  timeZone: "Asia/Seoul",
  dateStyle: "full",
  timeStyle: "short",
});
---

<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <meta name="viewport" content="width=device-width" />
    <meta name="generator" content={Astro.generator} />
    <meta
      name="description"
      content="Root Control Panel - Mission Control Management"
    />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <title>Root Control | Mission Control</title>
    <script is:inline>
      // Theme Init (Blocking to prevent FOUC)
      const savedTheme = localStorage.getItem("theme");
      const root = document.documentElement;
      // Default to light if no preference or if preference is light
      if (savedTheme === "light" || !savedTheme) {
        root.setAttribute("data-theme", "light");
        if (!savedTheme) localStorage.setItem("theme", "light");
      } else {
        root.setAttribute("data-theme", "dark");
      }
    </script>
  </head>
  <body>
    <div class="container">
      <!-- Header -->
      <header
        style="padding: 2rem 0; border-bottom: 1px solid var(--border-primary);"
      >
        <div
          style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;"
        >
          <div>
            <h1
              style="margin-bottom: 0.25rem; display: flex; align-items: center; gap: 0.75rem;"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                width="32"
                height="32"
                viewBox="0 0 24 24"
                fill="none"
                stroke="var(--accent-primary)"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
                class="lucide lucide-lock"
                ><rect width="18" height="11" x="3" y="11" rx="2" ry="2"
                ></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg
              >
              <span
                style="background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;"
                >Root Control Panel</span
              >
            </h1>
            <p style="margin: 0; color: var(--text-tertiary);">{currentTime}</p>
          </div>
          <div style="display: flex; gap: 1rem; align-items: center;">
            <button
              id="theme-toggle"
              class="btn btn-secondary"
              style="padding: 0.5rem; border-radius: 50%; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center;"
              aria-label="Toggle theme"
            >
              <span class="icon-sun">
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  width="20"
                  height="20"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  ><circle cx="12" cy="12" r="5"></circle><path d="M12 1v2"
                  ></path><path d="M12 21v2"></path><path
                    d="M4.22 4.22l1.42 1.42"></path><path
                    d="M18.36 18.36l1.42 1.42"></path><path d="M1 12h2"
                  ></path><path d="M21 12h2"></path><path
                    d="M4.22 19.78l1.42-1.42"></path><path
                    d="M18.36 5.64l1.42-1.42"></path></svg
                >
              </span>
              <span class="icon-moon" style="display: none;">
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  width="20"
                  height="20"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  ><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"
                  ></path></svg
                >
              </span>
            </button>
            <a href="/" class="btn btn-secondary" style="padding: 0.5rem 1rem;">
              ‚Üê Back to Dashboard
            </a>
          </div>
        </div>
      </header>

      <!-- Main Content -->
      <main style="padding: 2rem 0;">
        <!-- Active Projects Management -->
        <section style="margin-bottom: 3rem;" class="fade-in">
          <div class="card">
            <h2
              style="margin-bottom: 1.5rem; display: flex; align-items: center; gap: 0.75rem;"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                width="24"
                height="24"
                viewBox="0 0 24 24"
                fill="none"
                stroke="var(--accent-primary)"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
                class="lucide lucide-rocket"
                ><path
                  d="M4.5 16.5c-1.5 1.26-2 5-2 5s3.74-.5 5-2c.71-.84.7-2.13-.09-2.91a2.18 2.18 0 0 0-2.91-.09z"
                ></path><path
                  d="m12 15-3-3a22 22 0 0 1 2-3.95A12.88 12.88 0 0 1 22 2c0 2.72-.78 7.5-6 11a22.35 22.35 0 0 1-4 2z"
                ></path><path d="M9 12H4s.5-1 1-4c2 0 3 0 4 1z"></path><path
                  d="M12 15v5s1-.5 4-1c0-1 0-2-1-4z"></path><path d="M15 9l-1 1"
                ></path></svg
              >
              Active Projects Management
            </h2>
            <!-- Add Project -->
            <div
              style="margin-bottom: 2rem; padding: 1.5rem; background: var(--bg-tertiary); border-radius: 8px;"
            >
              <h3 style="margin-bottom: 1rem;">Add New Project</h3>
              <form
                id="add-project-form"
                style="display: flex; gap: 1rem; flex-wrap: wrap;"
              >
                <input
                  type="text"
                  id="new-project-name"
                  placeholder="Project Name"
                  style="flex: 1; padding: 0.75rem; border-radius: 6px; border: 1px solid var(--border-primary);"
                  required
                />
                <input
                  type="text"
                  id="new-project-desc"
                  placeholder="Description"
                  style="flex: 2; padding: 0.75rem; border-radius: 6px; border: 1px solid var(--border-primary);"
                  required
                />
                <select
                  id="new-project-status"
                  style="padding: 0.75rem; border-radius: 6px; border: 1px solid var(--border-primary);"
                >
                  <option value="Active">Active</option>
                  <option value="On Hold">On Hold</option>
                  <option value="Completed">Completed</option>
                  <option value="Planning">Planning</option>
                </select>
                <input
                  type="text"
                  id="new-project-tags"
                  placeholder="Tags (comma separated)"
                  style="flex: 1; padding: 0.75rem; border-radius: 6px; border: 1px solid var(--border-primary);"
                />
                <button type="submit" class="btn btn-primary"
                  >‚úö Add Project</button
                >
              </form>
            </div>
            <!-- Projects List Container -->
            <div id="projects-list" style="display: grid; gap: 1rem;"></div>
          </div>
        </section>

        <!-- Save & Export Section -->
        <section style="margin-top: 3rem;" class="fade-in">
          <div
            class="card"
            style="background: linear-gradient(135deg, var(--bg-elevated), var(--bg-tertiary)); border-color: var(--accent-primary);"
          >
            <h3 style="margin-bottom: 1rem;">Data Management</h3>
            <div
              style="display: flex; gap: 1rem; flex-wrap: wrap; margin-bottom: 1rem;"
            >
              <div style="color: var(--text-secondary); font-size: 0.9em;">
                Changes for projects are synchronized with the backend.
              </div>
            </div>
            <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
              <button class="btn btn-primary" id="save-btn"
                >üíæ Force Save to Server</button
              >
              <button class="btn btn-secondary" id="reset-btn"
                >üîÑ Clear Projects</button
              >
            </div>
          </div>
        </section>
      </main>
    </div>

    <script is:inline>
      // State
      let state = {
        projects: [],
        systems: [],
        metrics: [],
        activities: [],
      };

      const API_URL = "http://localhost:8000/api/dashboard";

      const ICON_MAP = {
        "üì°": `<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-layout-dashboard"><rect width="7" height="9" x="3" y="3" rx="1"/><rect width="7" height="5" x="14" y="3" rx="1"/><rect width="7" height="9" x="14" y="12" rx="1"/><rect width="7" height="5" x="3" y="16" rx="1"/></svg>`,
        "üöÄ": `<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-rocket"><path d="M4.5 16.5c-1.5 1.26-2 5-2 5s3.74-.5 5-2c.71-.84.7-2.13-.09-2.91a2.18 2.18 0 0 0-2.91-.09z"/><path d="m12 15-3-3a22 22 0 0 1 2-3.95A12.88 12.88 0 0 1 22 2c0 2.72-.78 7.5-6 11a22.35 22.35 0 0 1-4 2z"/><path d="M9 12H4s.5-1 1-4c2 0 3 0 4 1z"/><path d="M12 15v5s1-.5 4-1c0-1 0-2-1-4z"/><path d="M15 9l-1 1"/></svg>`,
        "‚öôÔ∏è": `<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-settings-2"><path d="M20 7h-9"/><path d="M14 17H5"/><circle cx="17" cy="17" r="3"/><circle cx="7" cy="7" r="3"/></svg>`,
        "üõ°Ô∏è": `<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-shield-check"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10"/><path d="m9 12 2 2 4-4"/></svg>`,
        "üåâ": `<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-bridge"><path d="M3 21v-4c0-2 1-3 3-3h12c2 0 3 1 3 3v4"/><path d="M3 7h18"/><path d="M6 7v7"/><path d="M18 7v7"/><path d="M12 7v7"/></svg>`,
        "üñ•Ô∏è": `<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-monitor"><rect width="20" height="14" x="2" y="3" rx="2"/><line x1="8" x2="16" y1="21" y2="21"/><line x1="12" x2="12" y1="17" y2="21"/></svg>`,
        "üß†": `<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-brain"><path d="M9.5 2A2.5 2.5 0 0 1 12 4.5v15a2.5 2.5 0 0 1-4.96.44 2.5 2.5 0 0 1-2.96-3.08 3 3 0 1 1 .34-5.58 2.5 2.5 0 0 1 1.32-4.24 2.5 2.5 0 0 1 3.76-1.04A2.5 2.5 0 0 1 9.5 2Z"/><path d="M14.5 2A2.5 2.5 0 0 0 12 4.5v15a2.5 2.5 0 0 0 4.96.44 2.5 2.5 0 0 0 2.96-3.08 3 3 0 1 0-.34-5.58 2.5 2.5 0 0 0-1.32-4.24 2.5 2.5 0 0 0-3.76-1.04A2.5 2.5 0 0 0 14.5 2Z"/></svg>`,
        "üéõÔ∏è": `<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-control"><rect width="18" height="18" x="3" y="3" rx="2"/><circle cx="12" cy="12" r="3"/><path d="M3 12h6"/><path d="M15 12h6"/><path d="M12 3v6"/><path d="M12 15v6"/></svg>`,
      };

      const replaceEmojiWithIcon = (text) => {
        let newText = text || "";
        for (const [emoji, icon] of Object.entries(ICON_MAP)) {
          if (newText.includes(emoji)) {
            newText = newText.replace(
              emoji,
              `<span class="icon-wrapper" style="display: inline-flex; align-items: center; justify-content: center; width: 1.2em; height: 1.2em; vertical-align: middle; margin-right: 0.25rem;">${icon}</span>`,
            );
          }
        }
        return newText;
      };

      // Fetch Initial Data
      async function init() {
        try {
          const res = await fetch(API_URL);
          const data = await res.json();
          if (data) {
            state = data;
            // Ensure arrays exist to avoid .map errors
            if (!state.projects) state.projects = [];
            if (!state.systems) state.systems = [];
            if (!state.metrics) state.metrics = [];
            if (!state.activities) state.activities = [];
            renderAll();
          }
        } catch (e) {
          console.error("Fetch failed", e);
        }
      }

      // Save Data
      async function save() {
        try {
          const response = await fetch(API_URL, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(state),
          });
          if (!response.ok) throw new Error("Server response not OK");
          console.log("Saved successfully");
        } catch (e) {
          console.error("Save failed", e);
        }
      }

      function renderProjects() {
        const list = document.getElementById("projects-list");
        if (!list) return;

        list.innerHTML = state.projects
          .map(
            (p, i) => `
            <div class="card" style="padding: 1.25rem; display: grid; grid-template-columns: 1fr 2fr 1fr 1fr auto; gap: 1rem; align-items: center;">
                <div style="display: flex; align-items: center; gap: 0.5rem; background: var(--bg-secondary); padding: 0.5rem; border-radius: 6px; border: 1px solid var(--border-primary);">
                   ${replaceEmojiWithIcon(p.name)}
                   <input value="${p.name}" onchange="updateState('projects', ${i}, 'name', this.value)" style="background: transparent; border: none; color: var(--text-primary); font-family: inherit; width: 100%;" />
                </div>
                <input value="${p.description}" onchange="updateState('projects', ${i}, 'description', this.value)" style="padding: 0.5rem; border-radius: 6px; border: 1px solid var(--border-primary); background: var(--bg-secondary); color: var(--text-primary);" />
                <select onchange="updateState('projects', ${i}, 'status', this.value)" style="padding: 0.5rem; border-radius: 6px; border: 1px solid var(--border-primary); background: var(--bg-secondary); color: var(--text-primary);">
                    <option value="Active" ${p.status === "Active" ? "selected" : ""}>Active</option>
                    <option value="On Hold" ${p.status === "On Hold" ? "selected" : ""}>On Hold</option>
                    <option value="Completed" ${p.status === "Completed" ? "selected" : ""}>Completed</option>
                    <option value="Planning" ${p.status === "Planning" ? "selected" : ""}>Planning</option>
                </select>
                <input value="${Array.isArray(p.tags) ? p.tags.join(", ") : p.tags || ""}" onchange="updateState('projects', ${i}, 'tags', this.value)" style="padding: 0.5rem; border-radius: 6px; border: 1px solid var(--border-primary); background: var(--bg-secondary); color: var(--text-primary);" />
                <button class="btn btn-secondary" onclick="removeItem('projects', ${i})" style="padding: 0.5rem; display: flex; align-items: center; justify-content: center;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-trash-2"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>
                </button>
            </div>
        `,
          )
          .join("");
      }

      function renderAll() {
        renderProjects();
      }

      window.updateState = (category, index, field, value) => {
        if (category === "projects" && field === "tags") {
          state.projects[index].tags = value
            .split(",")
            .map((t) => t.trim())
            .filter(Boolean);
        } else {
          state[category][index][field] = value;
        }
        save();
      };

      window.removeItem = (category, index) => {
        state[category].splice(index, 1);
        renderAll();
        save();
      };

      document
        .getElementById("add-project-form")
        .addEventListener("submit", (e) => {
          e.preventDefault();
          const tags = document.getElementById("new-project-tags").value;
          const newProject = {
            name: document.getElementById("new-project-name").value,
            description: document.getElementById("new-project-desc").value,
            status: document.getElementById("new-project-status").value,
            tags: tags
              .split(",")
              .map((t) => t.trim())
              .filter(Boolean),
          };
          state.projects.push(newProject);
          renderAll();
          save();
          e.target.reset();
        });

      document.getElementById("save-btn").addEventListener("click", save);
      document.getElementById("reset-btn").addEventListener("click", () => {
        if (confirm("Clear all projects?")) {
          state.projects = [];
          renderAll();
          save();
        }
      });

      // Theme toggle handler
      const toggleBtn = document.getElementById("theme-toggle");
      if (toggleBtn) {
        toggleBtn.addEventListener("click", () => {
          const current =
            document.documentElement.getAttribute("data-theme") || "light";
          const next = current === "dark" ? "light" : "dark";
          document.documentElement.setAttribute("data-theme", next);
          localStorage.setItem("theme", next);
          // swap icons
          const sun = document.querySelector(".icon-sun");
          const moon = document.querySelector(".icon-moon");
          if (next === "light") {
            sun.style.display = "inline";
            moon.style.display = "none";
          } else {
            sun.style.display = "none";
            moon.style.display = "inline";
          }
        });

        // Sync icons on load
        const root = document.documentElement;
        if (root.getAttribute("data-theme") === "dark") {
          const sun = document.querySelector(".icon-sun");
          const moon = document.querySelector(".icon-moon");
          if (sun) sun.style.display = "none";
          if (moon) moon.style.display = "inline";
        }
      }

      init();
    </script>
  </body>
</html>
