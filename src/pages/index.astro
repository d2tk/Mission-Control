---
import "../styles/global.css";

const currentTime = new Date().toLocaleString("en-US", {
  timeZone: "Asia/Seoul",
  dateStyle: "full",
  timeStyle: "short",
});
---

<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <meta name="viewport" content="width=device-width" />
    <meta name="generator" content={Astro.generator} />
    <meta
      name="description"
      content="Mission Control - Multi-Agent Command Center"
    />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <title>Mission Control | Command Center</title>

    <style>
      /* Layout & Container */
      body {
        background-color: var(--bg-primary);
        color: var(--text-primary);
        font-family: "Inter", sans-serif;
        transition: background-color 0.2s ease;
      }

      .dashboard-container {
        max-width: 1500px;
        margin: 0 auto;
        padding: 0 1.5rem 2rem 1.5rem;
      }

      #dashboard-grid {
        display: grid;
        grid-template-columns: 1fr;
        gap: 2rem;
        margin-top: 1.5rem;
        transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      }

      @media (min-width: 1024px) {
        #dashboard-grid {
          grid-template-columns: 1fr 340px; /* Main content + Sidebar width */
          gap: 2.5rem;
        }
      }

      #dashboard-grid.sidebar-hidden {
        grid-template-columns: 1fr 0px;
        gap: 0;
      }

      .main-column {
        display: flex;
        flex-direction: column;
        gap: 2.5rem;
      }

      #sidebar-column {
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
        transition: all 0.3s ease;
        overflow: hidden;
      }

      #dashboard-grid.sidebar-hidden #sidebar-column {
        opacity: 0;
        transform: translateX(20px);
        pointer-events: none;
      }

      /* Card Styling */
      .card {
        background: var(--bg-secondary);
        border: 1px solid var(--border-primary);
        border-radius: 12px;
        padding: 1.25rem;
        transition: all 0.2s ease;
      }

      .grid-card {
        min-height: 140px;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
      }

      .hover-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 16px rgba(0, 0, 0, 0.08);
        border-color: var(--accent-primary);
      }

      .empty-slot {
        border: 1px dashed var(--border-primary);
        border-radius: 12px;
        background: transparent;
        min-height: 140px;
        display: flex;
        align-items: center;
        justify-content: center;
        opacity: 0.3;
      }

      /* Typography */
      h1,
      h2,
      h3 {
        margin: 0;
      }

      .section-title {
        margin-bottom: 1rem;
        display: flex;
        align-items: center;
        gap: 0.6rem;
        font-size: 0.9rem;
        font-weight: 700;
        color: var(--text-tertiary);
        text-transform: uppercase;
        letter-spacing: 0.1em;
      }

      .section-divider {
        height: 2px;
        width: 40px;
        background: var(--accent-primary);
        border-radius: 2px;
      }

      /* Utility */
      .flex-between {
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .header-controls {
        display: flex;
        gap: 0.75rem;
        align-items: center;
      }

      .btn {
        cursor: pointer;
        font-family: inherit;
        border: none;
        outline: none;
      }

      /* Status Badges */
      .status-badge {
        display: inline-flex;
        align-items: center;
        padding: 0.45rem 1rem;
        border-radius: 999px;
        font-size: 0.65rem;
        font-weight: 800;
        text-transform: uppercase;
        letter-spacing: 0.15em;
        background: var(--bg-secondary);
        border: 1px solid var(--border-primary);
        transition: all 0.3s ease;
      }

      .status-success {
        color: var(--accent-success);
        background: none !important;
        border: none !important;
      }
      .status-warning {
        color: var(--accent-warning);
        background: none !important;
        border: none !important;
      }
      .status-error {
        color: var(--accent-error);
        background: none !important;
        border: none !important;
      }

      /* Animations */
      @keyframes pulse {
        0% {
          box-shadow: 0 0 0 0 rgba(var(--accent-success-rgb, 16, 185, 129), 0.4);
        }
        70% {
          box-shadow: 0 0 0 8px rgba(var(--accent-success-rgb, 16, 185, 129), 0);
        }
        100% {
          box-shadow: 0 0 0 0 rgba(var(--accent-success-rgb, 16, 185, 129), 0);
        }
      }
      .pulse-dot {
        animation: pulse 2.5s infinite;
      }
    </style>

    <script is:inline>
      // Theme Init (Blocking to prevent FOUC)
      const savedTheme = localStorage.getItem("theme");
      const root = document.documentElement;
      if (savedTheme === "light" || !savedTheme) {
        root.setAttribute("data-theme", "light");
        if (!savedTheme) localStorage.setItem("theme", "light");
      } else {
        root.setAttribute("data-theme", "dark");
      }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  </head>
  <body>
    <div class="dashboard-container">
      <!-- Header -->
      <header
        style="padding: 2rem 0; border-bottom: 1px solid var(--border-primary); margin-bottom: 2rem;"
      >
        <div class="flex-between" style="flex-wrap: wrap; gap: 1.5rem;">
          <!-- Branding & Time -->
          <div>
            <div
              class="flex-between"
              style="gap: 1rem; justify-content: flex-start;"
            >
              <div
                style="background: var(--accent-primary); padding: 8px; border-radius: 10px; display: flex; color: white; box-shadow: 0 4px 12px rgba(79, 70, 229, 0.2);"
              >
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  width="24"
                  height="24"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2.5"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                >
                  <rect width="7" height="9" x="3" y="3" rx="1"></rect>
                  <rect width="7" height="5" x="14" y="3" rx="1"></rect>
                  <rect width="7" height="9" x="14" y="12" rx="1"></rect>
                  <rect width="7" height="5" x="3" y="16" rx="1"></rect>
                </svg>
              </div>
              <h1
                style="font-size: 1.75rem; font-weight: 800; tracking: -0.02em;"
              >
                Mission Control
              </h1>
            </div>
            <p
              id="current-time"
              style="margin: 0.5rem 0 0 3.8rem; color: var(--text-tertiary); font-size: 0.75rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.15em; opacity: 0.7;"
            >
              {currentTime}
            </p>
          </div>

          <!-- Global Actions -->
          <div class="header-controls">
            <div
              id="global-status-indicator"
              class="status-badge"
              style="margin-right: 0.5rem; padding: 0.5rem 1.25rem; background: rgba(16, 185, 129, 0.05); border-color: rgba(16, 185, 129, 0.1);"
            >
              <span
                id="global-status-dot"
                class="pulse-dot"
                style="width: 10px; height: 10px; background: #10b981; border-radius: 50%; display: inline-block; margin-right: 0.75rem;"
              ></span>
              <span
                id="global-status-text"
                class="status-success"
                style="color: #10b981; font-weight: 900; letter-spacing: 0.2em;"
                >System Functional</span
              >
            </div>

            <div
              style="display: flex; gap: 0.5rem; background: var(--bg-secondary); padding: 4px; border-radius: 10px; border: 1px solid var(--border-primary);"
            >
              <button
                id="sidebar-toggle"
                class="btn card hover-card"
                style="padding: 0; width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; border-radius: 8px; background: transparent; border: none; box-shadow: none;"
                aria-label="Toggle Sidebar"
              >
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  width="18"
                  height="18"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  ><rect width="18" height="18" x="3" y="3" rx="2"></rect><path
                    d="M15 3v18"></path></svg
                >
              </button>

              <button
                id="theme-toggle"
                class="btn card hover-card"
                style="padding: 0; width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; border-radius: 8px; background: transparent; border: none; box-shadow: none;"
                aria-label="Toggle theme"
              >
                <span class="icon-sun"
                  ><svg
                    xmlns="http://www.w3.org/2000/svg"
                    width="18"
                    height="18"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    ><circle cx="12" cy="12" r="5"></circle><path d="M12 1v2"
                    ></path><path d="M12 21v2"></path><path
                      d="M4.22 4.22l1.42 1.42"></path><path
                      d="M18.36 18.36l1.42 1.42"></path><path d="M1 12h2"
                    ></path><path d="M21 12h2"></path><path
                      d="M4.22 19.78l1.42-1.42"></path><path
                      d="M18.36 5.64l1.42-1.42"></path></svg
                  ></span
                >
                <span class="icon-moon" style="display: none;"
                  ><svg
                    xmlns="http://www.w3.org/2000/svg"
                    width="18"
                    height="18"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    ><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"
                    ></path></svg
                  ></span
                >
              </button>
            </div>

            <button
              id="shutdown-btn"
              class="btn card hover-card"
              style="padding: 0; width: 44px; height: 44px; display: flex; align-items: center; justify-content: center; border-radius: 12px; color: var(--accent-error); border-color: rgba(239, 68, 68, 0.3); background: var(--bg-secondary);"
              aria-label="Shutdown System"
              title="Shutdown all backend services"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                width="20"
                height="20"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2.5"
                stroke-linecap="round"
                stroke-linejoin="round"
                ><path d="M18.36 6.64a9 9 0 1 1-12.73 0"></path><line
                  x1="12"
                  x2="12"
                  y1="2"
                  y2="12"></line></svg
              >
            </button>
          </div>
        </div>
      </header>

      <!-- Main Layout -->
      <main id="dashboard-grid">
        <!-- Main Column -->
        <div class="main-column">
          <!-- Active Projects Section -->
          <section class="fade-in">
            <h2 class="section-title">
              <span class="section-divider"></span>
              Active Projects
            </h2>
            <div class="grid grid-2" id="projects-grid">
              <div class="card"><p>Loading projects...</p></div>
            </div>
          </section>

          <!-- System Status Section -->
          <section class="fade-in" style="animation-delay: 0.1s;">
            <h2 class="section-title">
              <span class="section-divider"></span>
              Core Services
            </h2>
            <div id="core-services-container">
              <div class="card"><p>Loading system status...</p></div>
            </div>
          </section>
        </div>

        <!-- Sidebar Column -->
        <aside id="sidebar-column">
          <div
            class="card"
            style="border-left: 4px solid var(--accent-primary); padding: 1.5rem;"
          >
            <h3
              style="margin-top: 0; font-size: 0.75rem; color: var(--text-tertiary); font-weight: 800; text-transform: uppercase; letter-spacing: 0.15em; display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1.25rem;"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                width="14"
                height="14"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2.5"
                stroke-linecap="round"
                stroke-linejoin="round"
                ><path d="M12 20a8 8 0 1 0 0-16 8 8 0 0 0 0 16Z"></path><path
                  d="M12 14v2"></path><path d="M12 8h.01"></path></svg
              >
              Control Center
            </h3>
            <div style="display: flex; flex-direction: column; gap: 0.75rem;">
              <a
                href="/root_control"
                class="btn hover-card"
                style="display: flex; align-items: center; justify-content: space-between; text-decoration: none; padding: 1rem; background: var(--bg-tertiary); border-radius: 10px; color: var(--text-primary); font-size: 0.8rem; font-weight: 700;"
              >
                Root Access
                <svg
                  style="opacity: 0.4;"
                  xmlns="http://www.w3.org/2000/svg"
                  width="14"
                  height="14"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                  ><rect width="18" height="11" x="3" y="11" rx="2" ry="2"
                  ></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg
                >
              </a>
              <a
                href="/disk"
                class="btn hover-card"
                style="display: flex; align-items: center; justify-content: space-between; text-decoration: none; padding: 1rem; background: var(--bg-tertiary); border-radius: 10px; color: var(--text-primary); font-size: 0.8rem; font-weight: 700;"
              >
                Disk Manager
                <svg
                  style="opacity: 0.4;"
                  xmlns="http://www.w3.org/2000/svg"
                  width="14"
                  height="14"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                  ><ellipse cx="12" cy="5" rx="9" ry="3"></ellipse><path
                    d="M3 5V19A9 3 0 0 0 21 19V5"></path><path
                    d="M3 12A9 3 0 0 0 21 12"></path></svg
                >
              </a>
            </div>
          </div>

          <div style="padding: 0 0.5rem;">
            <h3
              class="section-title"
              style="font-size: 0.75rem; margin-bottom: 0.75rem;"
            >
              Command Relay
            </h3>
            <div
              class="card"
              style="padding: 1.25rem; background: var(--bg-tertiary); border: 1px solid var(--border-secondary); cursor: pointer;"
              onmouseover="this.style.borderColor='var(--accent-primary)'"
              onmouseout="this.style.borderColor='var(--border-secondary)'"
            >
              <div class="flex-between">
                <code
                  style="color: var(--accent-primary); font-weight: 800; font-size: 0.85rem;"
                  >!audit --full</code
                >
                <svg
                  style="opacity: 0.5;"
                  xmlns="http://www.w3.org/2000/svg"
                  width="14"
                  height="14"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="3"
                  stroke-linecap="round"
                  stroke-linejoin="round"><path d="m9 18 6-6-6-6"></path></svg
                >
              </div>
            </div>
          </div>

          <section>
            <a
              href="/docs"
              class="card hover-card"
              style="display: block; text-decoration: none; padding: 1.25rem; border: 1px dashed var(--border-primary);"
            >
              <div style="display: flex; align-items: flex-start; gap: 1rem;">
                <div
                  style="flex-shrink: 0; width: 42px; height: 42px; background: var(--bg-tertiary); border-radius: 10px; display: flex; align-items: center; justify-content: center; color: var(--text-tertiary);"
                >
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    width="20"
                    height="20"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    ><path
                      d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"
                    ></path><polyline points="14 2 14 8 20 8"></polyline><line
                      x1="16"
                      x2="8"
                      y1="13"
                      y2="13"></line><line x1="16" x2="8" y1="17" y2="17"
                    ></line><line x1="10" x2="8" y1="9" y2="9"></line></svg
                  >
                </div>
                <div>
                  <h3
                    style="margin: 0 0 0.25rem 0; color: var(--text-primary); font-size: 0.9rem; font-weight: 700;"
                  >
                    Documentation
                  </h3>
                  <p
                    style="margin: 0; color: var(--text-tertiary); font-size: 0.75rem; line-height: 1.4;"
                  >
                    System reports & logs
                  </p>
                </div>
              </div>
            </a>
          </section>

          <div
            style="text-align: center; margin-top: auto; padding-top: 2rem; color: var(--text-tertiary); font-size: 0.7rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.1em; opacity: 0.5;"
          >
            <p>Mission Control v1.0</p>
          </div>
        </aside>
      </main>

      <script is:inline>
        const API_URL = "http://localhost:8000/api/dashboard";
        const ICON_MAP = {
          "üì°": `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-layout-dashboard"><rect width="7" height="9" x="3" y="3" rx="1"/><rect width="7" height="5" x="14" y="3" rx="1"/><rect width="7" height="9" x="14" y="12" rx="1"/><rect width="7" height="5" x="3" y="16" rx="1"/></svg>`,
          "üöÄ": `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-rocket"><path d="M4.5 16.5c-1.5 1.26-2 5-2 5s3.74-.5 5-2c.71-.84.7-2.13-.09-2.91a2.18 2.18 0 0 0-2.91-.09z"/><path d="m12 15-3-3a22 22 0 0 1 2-3.95A12.88 12.88 0 0 1 22 2c0 2.72-.78 7.5-6 11a22.35 22.35 0 0 1-4 2z"/><path d="M9 12H4s.5-1 1-4c2 0 3 0 4 1z"/><path d="M12 15v5s1-.5 4-1c0-1 0-2-1-4z"/><path d="M15 9l-1 1"/></svg>`,
          "‚öôÔ∏è": `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-settings-2"><path d="M20 7h-9"/><path d="M14 17H5"/><circle cx="17" cy="17" r="3"/><circle cx="7" cy="7" r="3"/></svg>`,
          "üõ°Ô∏è": `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-shield-check"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10"/><path d="m9 12 2 2 4-4"/></svg>`,
          "üåâ": `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-bridge"><path d="M3 21v-4c0-2 1-3 3-3h12c2 0 3 1 3 3v4"/><path d="M3 7h18"/><path d="M6 7v7"/><path d="M18 7v7"/><path d="M12 7v7"/></svg>`,
          "üñ•Ô∏è": `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-monitor"><rect width="20" height="14" x="2" y="3" rx="2"/><line x1="8" x2="16" y1="21" y2="21"/><line x1="12" x2="12" y1="17" y2="21"/></svg>`,
          "üìÑ": `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-file-text"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><line x1="16" x2="8" y1="13" y2="13"/><line x1="16" x2="8" y1="17" y2="17"/><line x1="10" x2="8" y1="9" y2="9"/></svg>`,
          "üß†": `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-brain"><path d="M9.5 2A2.5 2.5 0 0 1 12 4.5v15a2.5 2.5 0 0 1-4.96.44 2.5 2.5 0 0 1-2.96-3.08 3 3 0 1 1 .34-5.58 2.5 2.5 0 0 1 1.32-4.24 2.5 2.5 0 0 1 3.76-1.04A2.5 2.5 0 0 1 9.5 2Z"/><path d="M14.5 2A2.5 2.5 0 0 0 12 4.5v15a2.5 2.5 0 0 0 4.96.44 2.5 2.5 0 0 0 2.96-3.08 3 3 0 1 0-.34-5.58 2.5 2.5 0 0 0-1.32-4.24 2.5 2.5 0 0 0-3.76-1.04A2.5 2.5 0 0 0 14.5 2Z"/></svg>`,
          "üéõÔ∏è": `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-control"><rect width="18" height="18" x="3" y="3" rx="2"/><circle cx="12" cy="12" r="3"/><path d="M3 12h6"/><path d="M15 12h6"/><path d="M12 3v6"/><path d="M12 15v6"/></svg>`,
          "ü§ñ": `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-bot"><path d="M12 8V4H8"/><rect width="16" height="12" x="4" y="8" rx="2"/><path d="M2 14h2"/><path d="M20 14h2"/><path d="M15 13v2"/><path d="M9 13v2"/></svg>`,
          "‚ú®": `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-sparkles"><path d="m12 3 1.912 5.813a2 2 0 0 0 1.275 1.275L21 12l-5.813 1.912a2 2 0 0 0-1.275 1.275L12 21l-1.912-5.813a2 2 0 0 0-1.275-1.275L3 12l5.813-1.912a2 2 0 0 0 1.275-1.275L12 3Z"/><path d="M5 3v4"/><path d="M19 17v4"/><path d="M3 5h4"/><path d="M17 19h4"/></svg>`,
          "üóÑÔ∏è": `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-archive"><rect width="20" height="5" x="2" y="3" rx="1"/><path d="M4 8v11a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8"/><path d="M10 12h4"/></svg>`,
        };

        const replaceEmojiWithIcon = (text) => {
          let newText = text;
          for (const [emoji, icon] of Object.entries(ICON_MAP)) {
            if (newText.includes(emoji)) {
              newText = newText.replace(
                emoji,
                `<span class="icon-wrapper" style="display: inline-flex; align-items: center; justify-content: center; width: 1.2em; height: 1.2em; vertical-align: middle; margin-right: 0.25rem;">${icon}</span>`,
              );
            }
          }
          return newText;
        };

        // Utility to fill empty grid slots for visual balance
        function fillWithEmptySlots(container, currentCount, targetGrid) {
          const remainder = currentCount % targetGrid;
          if (remainder !== 0 || currentCount === 0) {
            const slotsToAdd = targetGrid - remainder;
            for (let i = 0; i < slotsToAdd; i++) {
              const slot = document.createElement("div");
              slot.className = "empty-slot";
              slot.innerHTML = `<svg style="opacity: 0.2;" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M12 5v14M5 12h14"/></svg>`;
              container.appendChild(slot);
            }
          }
        }

        // Real-time Data Fetching
        const fetchDashboardData = async () => {
          try {
            const res = await fetch(API_URL);
            const data = await res.json();

            if (data) {
              renderGlobalStatus(data.all_systems_go);
              if (data.projects) renderProjects(data.projects);
              if (data.systems && data.agents)
                renderSystems(data.systems, data.agents);
            }
          } catch (e) {
            console.error("Failed to fetch dashboard data:", e);
          }
        };

        const renderGlobalStatus = (isOperational) => {
          const container = document.getElementById("global-status-indicator");
          const text = document.getElementById("global-status-text");
          const dot = document.getElementById("global-status-dot");

          if (!container || !text || !dot) return;

          if (isOperational) {
            container.style.background = "rgba(16, 185, 129, 0.05)";
            container.style.borderColor = "rgba(16, 185, 129, 0.1)";
            text.className = "status-success";
            text.textContent = "System Functional";
            text.style.color = "#10b981";
            dot.style.background = "#10b981";
          } else {
            container.style.background = "rgba(239, 68, 68, 0.05)";
            container.style.borderColor = "rgba(239, 68, 68, 0.1)";
            text.className = "status-error";
            text.textContent = "System Critical";
            text.style.color = "#ef4444";
            dot.style.background = "#ef4444";
          }
        };

        const renderProjects = (projects) => {
          const grid = document.getElementById("projects-grid");
          if (!grid) return;

          if (projects.length === 0) {
            grid.innerHTML = "";
            fillWithEmptySlots(grid, 0, 2);
            return;
          }

          grid.innerHTML = projects
            .map((p) => {
              const status = p.status.toLowerCase();
              let statusHtml = "";

              if (status === "active") {
                statusHtml = `
                    <div style="display: flex; align-items: center; gap: 0.4rem;">
                      <div style="width: 6px; height: 6px; border-radius: 50%; background: var(--accent-success);"></div>
                      <span style="font-weight: 800; font-size: 0.65rem; text-transform: uppercase; letter-spacing: 0.05em; color: var(--accent-success);">Active</span>
                    </div>
                  `;
              } else if (status === "completed" || status === "complete") {
                statusHtml = `
                    <div style="display: flex; align-items: center; gap: 0.4rem;">
                      <div style="width: 6px; height: 6px; border-radius: 50%; background: #D4AF37;"></div>
                      <span style="font-weight: 800; font-size: 0.65rem; text-transform: uppercase; letter-spacing: 0.05em; color: #D4AF37;">Complete</span>
                    </div>
                  `;
              } else if (status === "pending") {
                statusHtml = `
                    <div style="display: flex; align-items: center; gap: 0.4rem;">
                      <div style="width: 6px; height: 6px; border-radius: 50%; background: var(--accent-error);"></div>
                      <span style="font-weight: 800; font-size: 0.65rem; text-transform: uppercase; letter-spacing: 0.05em; color: var(--accent-error);">Pending</span>
                    </div>
                  `;
              } else {
                statusHtml = `<span class="status-badge" style="font-size: 0.65rem;">${p.status}</span>`;
              }

              return `
          <div class="card hover-card grid-card">
            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.75rem;">
              <h3 style="margin: 0; font-size: 1.1rem; font-weight: 800; tracking: -0.01em;">
                ${replaceEmojiWithIcon(p.name)}
              </h3>
              ${statusHtml}
            </div>
            <p style="margin-bottom: 1rem; color: var(--text-tertiary); font-size: 0.85rem; line-height: 1.5; font-weight: 500;">${p.description}</p>
            <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
              ${
                Array.isArray(p.tags)
                  ? p.tags
                      .map(
                        (tag) => `
                  <span style="background: var(--bg-tertiary); color: var(--text-tertiary); border: 1px solid var(--border-secondary); font-size: 0.65rem; padding: 0.2rem 0.5rem; border-radius: 6px; font-weight: 700;">${tag}</span>
              `,
                      )
                      .join("")
                  : ""
              }
            </div>
          </div>
        `;
            })
            .join("");

          fillWithEmptySlots(grid, projects.length, 2);
        };

        const renderSystems = (systems, agents) => {
          const container = document.getElementById("core-services-container");
          if (!container) return;

          const combined = [...systems];

          if (agents) {
            const agentList = [
              { id: "ChatGPT", icon: "ü§ñ" },
              { id: "Claude", icon: "‚ú®" },
            ];

            agentList.forEach((agent) => {
              const state = agents[agent.id] || { status: "not connected" };
              const status = state.status.toLowerCase();

              let displayStatus = "offline";
              if (status === "busy") displayStatus = "degraded";
              else if (status === "idle" || status === "ready")
                displayStatus = "operational";
              else if (status === "assistance required") displayStatus = "down";

              combined.push({
                name: `${agent.icon} ${agent.id}`,
                status: displayStatus,
                category: "AI Agents",
                description: state.current_task || `State: ${status}`,
              });
            });
          }

          const grouped = combined.reduce((acc, sys) => {
            const cat = sys.category || "Other";
            if (!acc[cat]) acc[cat] = [];
            acc[cat].push(sys);
            return acc;
          }, {});

          const order = [
            "AI Agents",
            "Core Systems",
            "Automation",
            "Monitoring",
            "Utilities",
          ];
          const categories = Object.keys(grouped).sort((a, b) => {
            const idxA = order.indexOf(a);
            const idxB = order.indexOf(b);
            if (idxA !== -1 && idxB !== -1) return idxA - idxB;
            if (idxA !== -1) return -1;
            if (idxB !== -1) return 1;
            return a.localeCompare(b);
          });

          container.innerHTML = categories
            .map((cat) => {
              const items = grouped[cat];
              const gridHtml = items
                .map((system, index) => {
                  const color =
                    system.status === "operational"
                      ? "success"
                      : system.status === "degraded"
                        ? "warning"
                        : "error";
                  const statusLabel =
                    system.status === "operational"
                      ? "Online"
                      : system.status === "degraded"
                        ? "Working"
                        : "Offline";

                  return `
            <div class="card hover-card grid-card" style="animation-delay: ${index * 0.05}s; border-left: 4px solid var(--accent-${color});">
              <div style="margin-bottom: 0.75rem;">
                <h3 style="font-size: 0.9rem; margin: 0; display: flex; align-items: center; gap: 0.5rem; line-height: 1.2; font-weight: 800; tracking: -0.01em;">
                  ${replaceEmojiWithIcon(system.name)}
                </h3>
                ${system.description ? `<p style="font-size: 0.7rem; color: var(--text-tertiary); margin: 0.35rem 0 0 0; line-height: 1.4; font-weight: 500; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;">${system.description}</p>` : ""}
              </div>
              <div style="display: flex; align-items: center; gap: 0.4rem; color: var(--text-tertiary); margin-top: auto;">
                 <div style="width: 6px; height: 6px; border-radius: 50%; background: var(--accent-${color}); ${color === "warning" ? "animation: pulse 2s infinite;" : ""}"></div>
                 <span style="font-weight: 800; font-size: 0.65rem; text-transform: uppercase; letter-spacing: 0.05em; color: var(--accent-${color});">
                   ${statusLabel}
                 </span>
              </div>
            </div>
          `;
                })
                .join("");

              const tempDiv = document.createElement("div");
              tempDiv.className = "grid grid-4";
              tempDiv.innerHTML = gridHtml;
              fillWithEmptySlots(tempDiv, items.length, 4);

              return `
                <div style="margin-bottom: 2.5rem;">
                    <h3 class="section-title" style="font-size: 0.75rem; border-bottom: 1px solid var(--border-secondary); padding-bottom: 0.6rem; color: var(--text-tertiary); opacity: 0.6;">${cat}</h3>
                    <div class="grid grid-4">${tempDiv.innerHTML}</div>
                </div>
              `;
            })
            .join("");
        };

        // Update time
        function updateTime() {
          const timeElement = document.getElementById("current-time");
          if (timeElement) {
            const now = new Date();
            timeElement.textContent =
              now.toLocaleDateString("ko-KR", {
                year: "numeric",
                month: "long",
                day: "numeric",
                weekday: "short",
              }) +
              " | " +
              now.toLocaleTimeString("en-US", { hour12: false });
          }
        }
        setInterval(updateTime, 1000);
        updateTime();

        // Theme toggle handler
        const themeToggle = document.getElementById("theme-toggle");
        if (themeToggle) {
          themeToggle.addEventListener("click", () => {
            const root = document.documentElement;
            const current = root.getAttribute("data-theme") || "dark";
            const newTheme = current === "dark" ? "light" : "dark";
            root.setAttribute("data-theme", newTheme);
            localStorage.setItem("theme", newTheme);

            const sun = document.querySelector(".icon-sun");
            const moon = document.querySelector(".icon-moon");
            if (newTheme === "light") {
              if (sun) sun.style.display = "inline";
              if (moon) moon.style.display = "none";
            } else {
              if (sun) sun.style.display = "none";
              if (moon) moon.style.display = "inline";
            }
          });

          const root = document.documentElement;
          if (root.getAttribute("data-theme") === "dark") {
            const sun = document.querySelector(".icon-sun");
            const moon = document.querySelector(".icon-moon");
            if (sun) sun.style.display = "none";
            if (moon) moon.style.display = "inline";
          }
        }

        // Sidebar toggle
        const sidebarToggle = document.getElementById("sidebar-toggle");
        const grid = document.getElementById("dashboard-grid");
        if (sidebarToggle && grid) {
          sidebarToggle.addEventListener("click", () => {
            grid.classList.toggle("sidebar-hidden");
          });
        }

        // Shutdown handler
        const shutdownBtn = document.getElementById("shutdown-btn");
        if (shutdownBtn) {
          shutdownBtn.addEventListener("click", async () => {
            if (
              !confirm(
                "‚ö†Ô∏è MISSION ABORT: Are you sure you want to shut down ALL backend services?",
              )
            )
              return;
            shutdownBtn.disabled = true;
            shutdownBtn.style.opacity = "0.5";
            try {
              const res = await fetch("http://localhost:8000/api/shutdown", {
                method: "POST",
              });
              if (res.ok) alert("üöÄ Shutdown sequence initiated.");
              else alert("‚ùå Shutdown failed.");
            } catch (e) {
              alert("üöÄ Shutdown command sent.");
              location.reload();
            }
          });
        }

        // Initial Fetch & Poll
        fetchDashboardData();
        setInterval(fetchDashboardData, 10000); // Polling every 10s
      </script>
    </div>
  </body>
</html>
