---
import "../styles/global.css";

const currentTime = new Date().toLocaleString("en-US", {
  timeZone: "Asia/Seoul",
  dateStyle: "full",
  timeStyle: "short",
});
---

<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <meta name="viewport" content="width=device-width" />
    <meta name="generator" content={Astro.generator} />
    <meta
      name="description"
      content="Mission Control - Multi-Agent Command Center"
    />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <!-- Previously known as Operational Board / Status Board -->
    <title>Mission Control | Command Center</title>
    <script is:inline>
      // Theme Init (Blocking to prevent FOUC)
      const savedTheme = localStorage.getItem("theme");
      const root = document.documentElement;
      // Default to light if no preference or if preference is light
      if (savedTheme === "light" || !savedTheme) {
        root.setAttribute("data-theme", "light");
        if (!savedTheme) localStorage.setItem("theme", "light");
      } else {
        root.setAttribute("data-theme", "dark");
      }
    </script>
  </head>
  <body>
    <div class="container">
      <!-- Header -->
      <header
        style="padding: 2rem 0; border-bottom: 1px solid var(--border-primary);"
      >
        <div
          style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;"
        >
          <div>
            <h1
              style="margin-bottom: 0.25rem; display: flex; align-items: center; gap: 0.75rem;"
            >
              <span style="font-size: 1.2em;">üì°</span>
              <span
                style="background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;"
                >Mission Control</span
              >
            </h1>
            <p style="margin: 0; color: var(--text-tertiary);">{currentTime}</p>
          </div>
          <div style="display: flex; gap: 1rem; align-items: center;">
            <button
              id="theme-toggle"
              class="btn btn-secondary"
              style="padding: 0.5rem; border-radius: 50%; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center;"
              aria-label="Toggle theme"
            >
              <span class="icon-sun">
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  width="20"
                  height="20"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  ><circle cx="12" cy="12" r="5"></circle><path d="M12 1v2"
                  ></path><path d="M12 21v2"></path><path
                    d="M4.22 4.22l1.42 1.42"></path><path
                    d="M18.36 18.36l1.42 1.42"></path><path d="M1 12h2"
                  ></path><path d="M21 12h2"></path><path
                    d="M4.22 19.78l1.42-1.42"></path><path
                    d="M18.36 5.64l1.42-1.42"></path></svg
                >
              </span>
              <span class="icon-moon" style="display: none;">
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  width="20"
                  height="20"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  ><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"
                  ></path></svg
                >
              </span>
            </button>
            <a
              href="/root_control"
              class="btn btn-primary"
              style="padding: 0.5rem 1rem; display: flex; align-items: center; gap: 0.5rem; text-decoration: none;"
            >
              <span>üîê</span> Root Control
            </a>
            <span
              id="global-status-indicator"
              class="status status-success pulse"
            >
              <span
                id="global-status-dot"
                style="width: 8px; height: 8px; background: var(--accent-success); border-radius: 50%; display: inline-block;"
              ></span>
              <span id="global-status-text">All Systems Operational</span>
            </span>
          </div>
        </div>
      </header>

      <!-- Main Content -->
      <main style="padding: 2rem 0;">
        <!-- Project List -->
        <section style="margin-bottom: 3rem;" class="fade-in">
          <h2
            style="margin-bottom: 1.5rem; display: flex; align-items: center; gap: 0.5rem;"
          >
            <span style="color: var(--text-primary);">üöÄ</span> Active Projects
          </h2>
          <div class="grid grid-2" id="projects-grid">
            <!-- Populated via JS -->
            <div class="card"><p>Loading projects...</p></div>
          </div>
        </section>

        <!-- System Status Grid -->
        <section
          style="margin-bottom: 3rem;"
          class="fade-in"
          style="animation-delay: 0.1s;"
        >
          <h2
            style="margin-bottom: 1.5rem; display: flex; align-items: center; gap: 0.5rem;"
          >
            <span style="color: var(--text-primary);">‚öôÔ∏è</span> Core Services
          </h2>
          <div class="grid grid-4" id="core-services-grid">
            <!-- Populated via JS -->
            <div class="card"><p>Loading system status...</p></div>
          </div>
        </section>

        <!-- Recent Activity -->
        <section class="fade-in" style="animation-delay: 0.4s;">
          <h2
            style="margin-bottom: 1.5rem; display: flex; align-items: center; gap: 0.5rem;"
          >
            <span style="color: var(--text-primary);">üì°</span> Recent Activity
          </h2>
          <div class="card">
            <div
              style="display: flex; flex-direction: column; gap: 1rem;"
              id="recent-activity-list"
            >
              <!-- Populated via JS -->
              <p>Loading activity...</p>
            </div>
          </div>
        </section>

        <!-- Quick Actions -->
        <section
          style="margin-top: 3rem;"
          class="fade-in"
          style="animation-delay: 0.6s;"
        >
          <div
            class="card"
            style="background: linear-gradient(135deg, var(--bg-elevated), var(--bg-tertiary)); border-color: var(--accent-primary);"
          >
            <h3 style="margin-bottom: 1rem;">Quick Actions</h3>
            <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
              <div
                style="display: flex; align-items: center; gap: 0.75rem; background: var(--bg-secondary); padding: 0.6rem 1.2rem; border-radius: 10px; border: 1px dashed var(--accent-primary); margin-right: 0.5rem;"
              >
                <code
                  style="color: var(--accent-primary); font-weight: bold; font-size: 1.1rem; background: var(--bg-tertiary); padding: 0.2rem 0.5rem; border-radius: 4px;"
                  >!audit</code
                >
                <span style="color: var(--text-secondary); font-size: 0.9rem;"
                  >Run a full system health and workspace audit report.</span
                >
              </div>
            </div>
          </div>
        </section>
      </main>

      <!-- Footer -->
      <footer
        style="padding: 2rem 0; border-top: 1px solid var(--border-primary); margin-top: 3rem;"
      >
        <div
          style="text-align: center; color: var(--text-tertiary); font-size: 0.875rem;"
        >
          <p style="margin: 0;">
            Mission Control v1.0 | Multi-Agent Command Center
          </p>
          <p style="margin: 0.5rem 0 0 0;">Powered by Astro + Flexoki Theme</p>
        </div>
      </footer>
    </div>

    <script>
      const API_URL = "http://localhost:8000/api/dashboard";

      // Real-time Data Fetching
      const fetchDashboardData = async () => {
        try {
          const res = await fetch(API_URL);
          const data = await res.json();

          if (data) {
            renderGlobalStatus(data.all_systems_go);
            if (data.projects) renderProjects(data.projects);
            if (data.systems) renderSystems(data.systems);
            if (data.activities) renderActivity(data.activities);
          }
        } catch (e) {
          console.error("Failed to fetch dashboard data:", e);
        }
      };

      const renderGlobalStatus = (isOperational) => {
        const container = document.getElementById("global-status-indicator");
        const dot = document.getElementById("global-status-dot");
        const text = document.getElementById("global-status-text");

        if (!container || !dot || !text) return;

        if (isOperational) {
          container.className = "status status-success pulse";
          dot.style.background = "var(--accent-success)";
          text.textContent = "All Systems Operational";
        } else {
          container.className = "status status-error pulse";
          dot.style.background = "var(--accent-error)";
          text.textContent = "System Critical";
        }
      };

      const renderProjects = (projects) => {
        const grid = document.getElementById("projects-grid");
        if (!grid) return;

        if (projects.length === 0) {
          grid.innerHTML = '<div class="card"><p>No active projects.</p></div>';
          return;
        }

        grid.innerHTML = projects
          .map(
            (p) => `
          <div class="card">
            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem;">
              <h3 style="font-size: 1.25rem; margin: 0; color: var(--accent-primary);">${p.name}</h3>
              <span class="status status-info">${p.status}</span>
            </div>
            <p style="margin-bottom: 1rem;">${p.description}</p>
            <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
              ${
                Array.isArray(p.tags)
                  ? p.tags
                      .map(
                        (tag) => `
                  <span class="status" style="background: var(--bg-tertiary); color: var(--text-secondary); border: 1px solid var(--border-secondary);">${tag}</span>
              `,
                      )
                      .join("")
                  : ""
              }
            </div>
          </div>
        `,
          )
          .join("");
      };

      const renderSystems = (systems) => {
        const grid = document.getElementById("core-services-grid");
        if (!grid) return;

        grid.innerHTML = systems
          .map((system, index) => {
            const color =
              system.status === "operational"
                ? "success"
                : system.status === "degraded"
                  ? "warning"
                  : "error";

            return `
            <div class="card" style="animation-delay: ${index * 0.1}s;">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                <h3 style="font-size: 1.125rem; margin: 0;">${system.name}</h3>
                <span class="status status-${color}" style="font-size: 0.75rem; padding: 0.25rem 0.625rem;">
                  ${system.status}
                </span>
              </div>
              <div style="display: flex; align-items: center; gap: 0.5rem; color: var(--text-secondary);">
                 <div style="width: 12px; height: 12px; border-radius: 50%; background: var(--accent-${color}); box-shadow: 0 0 8px var(--accent-${color});"></div>
                 <span style="font-weight: 500;">
                   ${system.status === "operational" ? "Running" : "Stopped"}
                 </span>
              </div>
            </div>
          `;
          })
          .join("");
      };

      const renderActivity = (activities) => {
        const list = document.getElementById("recent-activity-list");
        if (!list) return;

        // Take top 7
        const recent = activities.slice(0, 7);

        list.innerHTML = recent
          .map(
            (activity, index) => `
              <div style="display: flex; gap: 1rem; padding-bottom: 1rem; ${index < recent.length - 1 ? "border-bottom: 1px solid var(--border-primary);" : ""}">
                <div style="min-width: 60px; color: var(--text-tertiary); font-size: 0.875rem; font-family: monospace;">
                  ${activity.time}
                </div>
                <div style="flex: 1;">
                  <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.25rem;">
                    <span style="font-weight: 600; color: var(--accent-primary);">${activity.agent}</span>
                    <span class="status status-${activity.type}" style="font-size: 0.7rem; padding: 0.125rem 0.5rem;">
                      ${activity.type}
                    </span>
                  </div>
                  <p style="margin: 0; color: var(--text-secondary); font-size: 0.9rem;">${activity.action}</p>
                </div>
              </div>
        `,
          )
          .join("");
      };

      // Update time
      setInterval(() => {
        const timeElement = document.querySelector("header p");
        if (timeElement) {
          const now = new Date().toLocaleString("en-US", {
            timeZone: "Asia/Seoul",
            dateStyle: "full",
            timeStyle: "short",
          });
          timeElement.textContent = now;
        }
      }, 1000);

      // Initial Fetch & Poll
      fetchDashboardData();
      setInterval(fetchDashboardData, 3000);
    </script>
    <script>
      // Theme toggle handler
      const toggleBtn = document.getElementById("theme-toggle");
      if (toggleBtn) {
        toggleBtn.addEventListener("click", () => {
          const root = document.documentElement;
          const current = root.getAttribute("data-theme") || "dark";
          const newTheme = current === "dark" ? "light" : "dark";
          root.setAttribute("data-theme", newTheme);
          localStorage.setItem("theme", newTheme);
          // swap icons
          const sun = document.querySelector(".icon-sun");
          const moon = document.querySelector(".icon-moon");
          if (newTheme === "light") {
            sun.style.display = "inline";
            moon.style.display = "none";
          } else {
            sun.style.display = "none";
            moon.style.display = "inline";
          }
        });

        // Sync icons on load
        const root = document.documentElement;
        if (root.getAttribute("data-theme") === "dark") {
          const sun = document.querySelector(".icon-sun");
          const moon = document.querySelector(".icon-moon");
          if (sun) sun.style.display = "none";
          if (moon) moon.style.display = "inline";
        }
      }
    </script>
  </body>
</html>
